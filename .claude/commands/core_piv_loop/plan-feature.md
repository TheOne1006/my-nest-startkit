---
description: "通过深入的代码库分析和研究，制定全面的功能计划"
---

# 规划新任务 (Plan a new task)

## 功能: $ARGUMENTS

## 使命

通过系统的代码库分析、外部研究和战略规划，将功能请求转化为**全面的实施计划**。

**核心原则**: 我们在这个阶段**不编写代码**。我们的目标是创建一个上下文丰富的实施计划，使 AI 代理能够一次性成功实施。

**关键理念**: 上下文为王。计划必须包含实施所需的所有信息 - 模式、必读材料、文档、验证命令 - 以便执行代理在第一次尝试时就能成功。

## 规划流程

### 第一阶段：功能理解

**深度功能分析：**

- 提取正在解决的核心问题
- 确定用户价值和业务影响
- 确定功能类型：新能力/增强/重构/错误修复
- 评估复杂性：低/中/高
- 映射受影响的系统和组件

**创建用户故事格式（如果用户提供了故事，则进行细化）：**

```
作为 <用户类型>
我想要 <行动/目标>
以便 <好处/价值>
```

### 第二阶段：代码库情报收集

**使用专门的代理和并行分析：**

**1. 项目结构分析**

- 检测主要语言、框架和运行时版本 (TypeScript, NestJS)
- 映射目录结构和架构模式 (Feature Modules)
- 识别服务/组件边界和集成点
- 定位配置文件 (`package.json`, `nest-cli.json` 等)
- 查找环境设置和构建流程

**2. 模式识别** (在有益时使用专门的子代理)

- 在代码库中搜索类似的实现
- 识别编码规范：
  - 命名模式 (PascalCase 类, kebab-case 文件)
  - 文件组织和模块结构
  - 错误处理方法 (Global Filters, Custom Exceptions)
  - 日志模式和标准 (Winston)
  - DTO 和验证模式 (class-validator)
- 提取功能域的通用模式
- 记录要避免的反模式
- 检查 `CLAUDE.md` 以获取项目特定的规则和公约

**3. 依赖分析**

- 编目与功能相关的外部库
- 了解库是如何集成的（检查导入、配置）
- 在 `docs/`、`.claude/reference` 或 ai-wiki 中查找相关文档（如果有）
- 注意库版本和兼容性要求

**4. 测试模式**

- 识别测试框架和结构 (Jest, `*.spec.ts`, `test/*.e2e-spec.ts`)
- 查找类似的测试示例以供参考
- 了解测试组织（单元测试 vs E2E 测试）
- 注意覆盖率要求和测试标准

**5. 集成点**

- 识别需要更新的现有文件
- 确定需要创建的新文件及其位置
- 映射路由/API 注册模式 (Controllers, Modules)
- 如果适用，了解数据库/模型模式 (Prisma Schema)
- 如果相关，识别认证/授权模式 (Guards, Decorators)

**澄清歧义：**

- 如果此时需求不明确，请在继续之前要求用户澄清
- 获取具体的实施偏好（库、方法、模式）
- 在继续之前解决架构决策

### 第三阶段：外部研究与文档

**在进行外部研究时，使用专门的子代理：**

**文档收集：**

- 研究最新的库版本和最佳实践
- 查找具有特定章节锚点的官方文档
- 定位实施示例和教程
- 识别常见的陷阱和已知问题
- 检查重大更改和迁移指南

### 第四阶段：制定计划

**创建实施计划文档 (`.claude/plans/[feature-name].md`)：**

**1. 计划元数据**
- 功能名称
- 目标摘要
- 复杂性评估

**2. 关键架构决策**
- 选用的模式和理由
- 数据模型变更 (Prisma)
- API 接口设计 (Swagger)

**3. 详细任务列表 (按顺序)**
- 细分每个步骤 (创建 DTO -> Service -> Controller -> Module)
- 指定具体的文件路径
- 包含验证每个步骤的方法

**4. 测试策略**
- 单元测试覆盖范围
- E2E 测试场景
- 测试数据准备

**5. 验证命令**
- 构建命令
- 测试命令
- Lint/Format 命令

## 输出

生成完整的计划文件，并询问用户是否批准或需要修改。
